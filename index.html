<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Handsontable Example</title>
  <!-- 修改后的路径 -->
  <link rel="stylesheet" href="./handsontable.full.min.css">
  <script src="./handsontable.full.min.js"></script>
  <script src="./hyperformula.full.min.js"></script>
  <script src="./zh-CN.js"></script>
  <script src="./main.js"></script>

</head>
<body>
    Hello World!
  <!-- <div class="big">
      我是14px=1.4rem
      <div class="small">我是12px=0.5rem</div>
  </div> -->
  <div id="container1"></div>
  <div id="container2"></div>


  <!-- <div class="par">
    <div class="child">child1</div>
  </div>

  <div class="father">
    <div class="son"></div>
  </div>

  <div class="box">
    <div class="left">左边</div>
    <div class="right">右边</div>
  </div>

  <div class="wrap4">
    <div class="left4">左侧</div>
    <div class="right4">右侧</div>
    <div class="middle4">中间</div>
  </div>

  <div class="container5">
    <div class="left5">左边固定宽度</div>
    <div class="main5">中间自适应</div>
    <div class="right5">右边固定宽度</div>
  </div> -->

  <script>
    function indentRenderer(instance, td, row, col, prop, value, cellProperties) {
      // 清除默认的渲染内容
      Handsontable.renderers.BaseRenderer.apply(this, arguments);

      if (value !== null && value !== undefined) {
        const indentLevel = cellProperties.indentLevel || 0; // 从单元格属性中获取缩进层级
        const indentSize = 20; // 每层缩进的宽度
        td.style.textIndent = `${indentLevel * indentSize}px`; // 应用缩进
        td.innerHTML = value; // 渲染单元格内容
      }
    }

    const container = document.getElementById('container');

    console.log('@@@@@@@@@@@@',localStorage.getItem('indentSettings'));

    // 存储缩进信息的数组
    let indentSettings = JSON.parse(localStorage.getItem('indentSettings')) || [];

    const saveIndentSettings = () => {
      // console.log('@@@',saveIndentSettings);
      localStorage.setItem('indentSettings', JSON.stringify(indentSettings));
    };

    const data = [
        ["", "Tesla", "Nissan", "Toyota", "Honda"],
        ["2019", 10, 11, 12, 13],
        ["2020", 20, 21, 22, 23],
        ["2021", 30, 31, 32, 33]
    ];

    const hot = new Handsontable(container1, {
      data: data,
      rowHeaders: true,
      colHeaders: true,
      language: 'zh-CN', 
      mergeCells: true,
      formulas: {
        engine: HyperFormula // 使用 HyperFormula 作为公式解析器
      },
      contextMenu: {
        callback: function (key, options) {
          console.log(`Menu item '${key}' triggered`);
        },
        items: {
          ...Handsontable.plugins.ContextMenu.DEFAULT_ITEMS, // 保留默认菜单项
          "increase_indent": {
            name: "缩进",
            callback: function (_, selection) {
              const selected = selection[0]; // 获取选中区域
              for (let row = selected.start.row; row <= selected.end.row; row++) {
                for (let col = selected.start.col; col <= selected.end.col; col++) {
                  const cellMeta = hot.getCellMeta(row, col);
                  cellMeta.indentLevel = (cellMeta.indentLevel || 0) + 1; // 增加缩进层级
                  hot.setCellMeta(row, col, 'indentLevel', cellMeta.indentLevel);

                  // 更新缩进设置数组
                  const index = indentSettings.findIndex(item => item.row === row && item.col === col);
                  if (index === -1) {
                    indentSettings.push({ row, col, indentLevel: cellMeta.indentLevel });
                  } else {
                    indentSettings[index].indentLevel = cellMeta.indentLevel;
                  }
                }
              }
              saveIndentSettings();
              hot.render(); // 重新渲染表格
              // console.log('###',indentSettings);
            },
          },
          "decrease_indent": {
            name: "取消缩进",
            callback: function (_, selection) {
              const selected = selection[0]; // 获取选中区域
              for (let row = selected.start.row; row <= selected.end.row; row++) {
                for (let col = selected.start.col; col <= selected.end.col; col++) {
                  const cellMeta = hot.getCellMeta(row, col);
                  cellMeta.indentLevel = Math.max((cellMeta.indentLevel || 0) - 1, 0); // 减少缩进层级，不低于0
                  hot.setCellMeta(row, col, 'indentLevel', cellMeta.indentLevel);
                  // 更新缩进设置数组
                  const index = indentSettings.findIndex(item => item.row === row && item.col === col);
                  if (index !== -1) {
                    if (cellMeta.indentLevel === 0) {
                      indentSettings.splice(index, 1); // 移除无缩进的单元格记录
                    } else {
                      indentSettings[index].indentLevel = cellMeta.indentLevel;
                    }
                  }
                }
              }
              saveIndentSettings();
              hot.render(); // 重新渲染表格
              // console.log('###',indentSettings);
            },
          }
        }
      },
      cells: function (row, col) {
        const cellProperties = {};
        // 判断是否是第一行或第一列（原始数据部分）
        if (row === 1 || col === 2) {
          cellProperties.readOnly = true; // 设置为只读
        }
        const cell = indentSettings.find(item => item.row === row && item.col === col);
        if (cell) {
          cellProperties.indentLevel = cell.indentLevel; // 加载存储的缩进级别
        }
        cellProperties.renderer = indentRenderer; // 使用自定义渲染器
        return cellProperties;
      },
      licenseKey: 'non-commercial-and-evaluation',
      // afterRender: function () {
      //   const plugin = hot.getPlugin('formulas');
      //   const cells = container.querySelectorAll('td');

      //   cells.forEach((cell, index) => {
      //     const coords = hot.getCoords(cell);
      //     if (coords && coords.row >= 0 && coords.col >= 0) {
      //       const formula = plugin.engine.getCellFormula({
      //         sheet: 0,
      //         row: coords.row,
      //         col: coords.col
      //       });

      //       // 如果单元格有公式，添加 title 属性
      //       if (formula) {
      //         cell.setAttribute('title', `公式: ${formula}`);
      //       } else {
      //         cell.removeAttribute('title');
      //       }
      //     }
      //   })
      // }
    })

    const hot2 = new Handsontable(container2, {
      data: data,
      rowHeaders: true,
      colHeaders: true,
      language: 'zh-CN', 
      mergeCells: true,
      formulas: {
        engine: HyperFormula // 使用 HyperFormula 作为公式解析器
      },
      // contextMenu:true
      contextMenu:{
        callback: (key, options) => {
              console.log(`$$$Menu item '${key}' triggered`);
            },
            items: {
              ...Handsontable.plugins.ContextMenu.DEFAULT_ITEMS, // 保留默认菜单项
              mergeCells:{}
            }
      }
    })

    hot.render();

  </script>
  <style>
        /* rem */
        html {font-size: 100%;  } /*  100%默认是16px；公式16px*62.5%=10px  */  
        .big{font-size: 1.4rem}
        .small{font-size: 1rem}

        /* 水平垂直居中display: flex; + float: left; */
        .par {
            display: flex;
            justify-content: center;
            align-items: center;
            border: 5px solid #fcc;
            width: 500px;
            height: 200px;
        }
    
        .child {
            border: 5px solid #f66;
            width:100px;
            height: 100px;
            float: left;
        }

        /* 水平垂直居中position: absolute; + margin:auto; */
        .father{
            width:500px;
            height:300px;
            border:1px solid #0a3b98;
            position: relative;
        }
        .son{
            width:100px;
            height:40px;
            background: #f0a238;
            position: absolute;
            top:0;
            left:0;
            right:0;
            bottom:0;
            margin:auto;
        }
        /* 左右布局 */
        .box{
            display: flex;
            border: 5px solid #fcc;
        }
        .left {
            width: 100px;
            border:1px solid #0a3b98;
        }
        .right {
            flex: 1;
            border:1px solid #0a3b98;
        }
        /* 三栏布局 */
        .wrap4 {
            background: #eee;
            overflow: hidden; 
            padding: 20px;
            height: 200px;
        }
        .left4 {
            width: 200px;
            height: 200px;
            float: left;
            background: coral;
        }
        .right4 {
            width: 120px;
            height: 200px;
            float: right;
            background: lightblue;
        }
        .middle4 {
            margin-left: 220px;
            height: 200px;
            background: lightpink;
            margin-right: 140px;
        }
        /* display: table */
        .container5 {
          height: 200px;
          line-height: 200px;
          text-align: center;
          display: table;
          table-layout: fixed;
          width: 100%;
        }

        .left5,
        .right5,
        .main5 {
          display: table-cell;
        }

        .left5,
        .right5 {
          width: 100px;
          background: green;
        }

        .main5 {
          background:  #fcc;
          color: white;
          width: 100%;
        }
        /* 如果你在一个flex容器中有多个项目，并且你将它们都设置为flex:1，它们将平均分配容器的空间。 */
  </style>
</body>
</html>
